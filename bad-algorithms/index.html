
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://virgesmith.github.io/bad-algorithms/">
      
      
        <meta name="author" content="Andrew P Smith">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.5">
    
    
      
        <title>Bad algorithms - Random Rants</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.21aed14c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.196e0c26.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-purple">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bad-algorithms" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://virgesmith.github.io" title="Random Rants" class="md-header-nav__button md-logo" aria-label="Random Rants">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Random Rants
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Bad algorithms
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/virgesmith/virgesmith.github.io/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://virgesmith.github.io" title="Random Rants" class="md-nav__button md-logo" aria-label="Random Rants">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Random Rants
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/virgesmith/virgesmith.github.io/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" >
    <label class="md-nav__link" for="nav-1">
      Articles
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Articles" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Articles
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../anatomy/" class="md-nav__link">
      Anatomy of a successful research software project
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" class="md-nav__link">
      About me
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#worse-than-exponential-algorithms" class="md-nav__link">
    Worse-than-exponential algorithms
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/virgesmith/virgesmith.github.io/edit/master/docs/bad-algorithms.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="bad-algorithms">Bad algorithms<a class="headerlink" href="#bad-algorithms" title="Permanent link">¶</a></h1>
<p>The Fibonacci sequence is an integer series beginning 0, 1 where every successive digit is the sum of the previous two:</p>
<div class="arithmatex">\[0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55...\]</div>
<p>The definition</p>
<div class="arithmatex">\[F\big(n\big) = \left\{\begin{matrix}
&amp; n &amp; n \in {0,1} \\
&amp; F\big(n-1\big) + F\big(n-2\big) &amp; n \in \mathbb{Z}^{+} \setminus{1}
\end{matrix}\right.\]</div>
<p>lends itself directly to a recursive implementation, e.g. in python:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">fib_recursive</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
  <span class="k">global</span> <span class="n">calls</span>
  <span class="n">calls</span> <span class="o">=</span> <span class="n">calls</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">n</span>
  <span class="k">return</span> <span class="n">fib_recursive</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib_recursive</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<p>[file: <strong>src/fib.py</strong>]</p>
<p>In the python implementation, as python is a dynamically typed language, we need to check that the argument is both a valid type (integral) and a valid value (non-negative). It makes sense to do this only once - the first time the function is called - so the recursive implementation is split into a separate function.</p>
<p>The rust implementation, thanks to static typing and an unsigned integral type, doesn't require these checks, although it may overflow if <span class="arithmatex">\(n\)</span> is high enough and return an incorrect result.</p>
<p>However in both cases there is a major problem with the implementation. For each recursive call to <code>fib</code> <strong>two</strong> further calls to the function are made and thus there is a potential for the call stack to grow exponentially. For large <span class="arithmatex">\(n\)</span> this will cause the program to run out of resources very quickly.</p>
<p>It turns out that, in general, for an input value of <span class="arithmatex">\(n\)</span>, there will be about <span class="arithmatex">\(\phi^n\)</span> calls to <code>fib</code>, where <span class="arithmatex">\(\phi\)</span> is the Golden ratio (~1.618). For example this table illustrates the number of calls to the python implementation for a small range of <span class="arithmatex">\(n\)</span>:</p>
<p>//$include md output/fib_recursive_table.md</p>
<p>Or in graphical form, the execution time:</p>
<p><img alt="" src="../img/fib_recursive_time.png" /></p>
<p>and the number of calls is clearly the dominant factor causing the execution time:</p>
<p><img alt="" src="../img/fib_recursive_calls.png" /></p>
<p>As you can see, for even fairly small n the function is taking prohibitively long to run, and calling itself hundreds of millions of times. In algorithmic complexity terms, this is known as <em>exponential time complexity</em> and should be avoided at all costs. The point I'm trying to make here is that the obvious (but perhaps naiive) implementation of a mathematical function is not always the best approach, and a good (research or otherwise) software engineer should know this.</p>
<p>So lets try again. Perhaps a better approach would be to compute the entire sequence up to <span class="arithmatex">\(n\)</span> and just return the final value, in python something like:</p>
<p><code>ERROR src/fib.py (python) too few/many tags (0) for '!fib-array!'</code></p>
<p>And the execution time is vastly improved:</p>
<p>{ include_snippet("docs/output/fib_array_table.md") }}</p>
<!--![](./img/fib_array_time.png)-->

<p>The question is, what does this graph tell us about how the execution time of the array Fibonacci algorithm varies with <span class="arithmatex">\(n\)</span>?. Looking at the code we can see that there is one loop so it would be reasonable to expect that the algorithm is <span class="arithmatex">\(O\big(n\big)\)</span> (it actually is). But the data is very noisy, so how do we determine</p>
<ol>
<li>that he behaviour <em>is</em> linear, and</li>
<li>the slope, so that we can estimate execution time by extrapolation?</li>
</ol>
<p>Data scientists would perhaps initially suggest linear regression, others might simply suggest averaging the execution time over multiple runs, but there is a problem with this: the noise is biased. Here's why.</p>
<p>Modern operating systems run hundreds of processes on hardware that has multiple cores and these processes are competing to consume resources. But CPUs can only run a small number of processes simulteneously, so the operating system has to be able to share the CPU resources between all the processes. Whilst operating systems are cleverly designed to hide all this and provide a smooth user experience, there are limits. I'm sure you've all experienced the slowdowns incurred when a process maximises CPU usage or the system runs low on memory.</p>
<p>When you are profiling code, however, these effects become much more noticeable, and particularly in interpreted or garbage-collected languages where the language runtime itself could be competing with your code for CPU resources. So using actual time (often called <em>wall time</em>, referring to a wall clock) is a very crude measure of performance. Low-level profiling tools use much more sophisticated metrics including analysis at the hardware level, but these tools require some effort (and sometimes money) to get working, so may not be available to everyone, and may be overkill for a quick benchmark.</p>
<p>Any program will have a theoretical minimum execution time for a given platform, when (by chance) it is not impeded by competing processes or threads, and this value is really what we are looking for when we want to determine how the values if <span class="arithmatex">\(n\)</span> impacts execution time. So there's a simple solution, instead of <em>averaging</em> multiple runs, we should take the <em>minimum</em> of multiple runs - put another way, we need never to worry about a datapoint <em>underestimating</em> the execution time.</p>
<p>As you can see from the red points in the graph below, there is a much clearer linear signal emerging using only 3 runs:</p>
<!--[](./img/fib_array_time_min3.png)-->

<p>TODO extrapolation is dangerous...</p>
<p>The only drawback of the array Fibonacci algorithm is that the amount of storage required to compute the value grows with <span class="arithmatex">\(n\)</span>, and all the intermediate results are discarded. Specifically, this algorithm has both <em>linear time compexity</em> and <em>linear space complexity</em>, since both the number of operations and the amount of storage is proportional to <span class="arithmatex">\(n\)</span>. If we were calculating terms in the sequence for lots of very large <span class="arithmatex">\(n\)</span> this could potentially be problematic with storage: there could potentially be a lot of redundant computation and duplication of data, plus a lot of repeated memory allocations and deallocations will impact performance.</p>
<p>Since there is only one sequence, a better approach could be to have a single cached sequence that is extended as necessary. In C++ you could implement it like so:</p>
<p>{ include_snippet("src/fib.cpp", "fib-cached") }}</p>
<p>However, if you tried a similar approach in rust, you would encounter a very unhappy compiler. It's worth looking into the reasons why this is the case. Basically, this code is not threadsafe. Imagine that it's being called roughly simultaneously by two threads, each requiring different values. Let's say thread 1 calls the function asking for the 100th number in the sequence, and the cache contains only 50 values. It will resize the cache to 101 and start to compute the missing values. Now thread 2 might enter the function whilst this is happening, and want the 75th value in the sequence. It will check the cache size and decide it can simply return the approriate value. The problem is, we don't actually know whether that value has been computed yet, so the result may be wrong, or it may (by luck) be correct if thread 1 has got that far.</p>
<p>This is an example of <em>undefined behaviour</em>. Programs like this are not deterministic as it's impossible to say where individual threads will be relative to each other during program execution. The results may or may not be incorrect, the program may even crash, and debugging is extremely difficult as it's often impossible to consistently reproduce an error.</p>
<p>Undefined behaviour is perhaps <em>the</em> prime motive for the development of rust. The rust compiler is extremely strict and this strictness enables it to detect many situations where undefined behaviour may arise. For this reason rust is often considered a difficult language to learn, especially for those coming from more forgiving languages. All I can say is it's worth it. Even if you go back to your old, more forgiving, language you will look at your code in a new, more defensive, light.</p>
<p>We could fix the problem in the C++ code above by blocking multiple threads entering the function (using a construct called a mutex lock). But this is likely to result in degraded performance, and more complicated code, which has a maintenance overhead.</p>
<p>The days when it was quicker to cache simple computations (reading precomputed random numbers from a file was once a thing!) are way behind us. The increase in CPU performance over that last decades has been even greater than those memory or even disk performance.</p>
<p>So perhaps the best solution might be simpler... going back to the definition, we see that we don't need to store every term, we only need the previous two terms in order to compute the next term. So we should be able to write an algorithm that is linear in time complexity and constant in space complexity.</p>
<h2 id="worse-than-exponential-algorithms">Worse-than-exponential algorithms<a class="headerlink" href="#worse-than-exponential-algorithms" title="Permanent link">¶</a></h2>
<p>Perversely I wanted to explore how could implement something even more insanely inefficient than an exponential time algorithm so I had an idea...</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">¶</a></h2>
<p>Dasgupta, Papadimitriou and Vazirani, Algorithms, McGraw-Hill, 2008. ISBN 978-0-07-352340-8</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy 2020 Andrew P Smith
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../assets/javascripts/bundle.b3a72adc.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../js/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>